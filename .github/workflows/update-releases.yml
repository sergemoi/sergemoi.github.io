name: Update Release Notes

on:
  schedule:
    # Runs every 6 hours. Adjust as needed:
    # Every hour:  '0 * * * *'
    # Every 12h:   '0 */12 * * *'
    # Once daily:  '0 9 * * *'
    - cron: '0 */12 * * *'

  # Manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write

env:
  APP_STORE_ID: '6749635860'
  APP_STORE_COUNTRY: 'us'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check App Store and update releases
        id: check
        run: |
          set -e

          echo "ðŸ” Fetching App Store data..."
          RESPONSE=$(curl -sf "https://itunes.apple.com/lookup?id=${APP_STORE_ID}&country=${APP_STORE_COUNTRY}")

          # Parse response
          VERSION=$(echo "$RESPONSE" | jq -r '.results[0].version')
          DESCRIPTION=$(echo "$RESPONSE" | jq -r '.results[0].releaseNotes')
          DATE=$(echo "$RESPONSE" | jq -r '.results[0].currentVersionReleaseDate')
          APP_NAME=$(echo "$RESPONSE" | jq -r '.results[0].trackName')

          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
            echo "Could not fetch app info. Check your APP_STORE_ID."
            exit 1
          fi

          echo "App: $APP_NAME"
          echo "Latest version: $VERSION"

          # Initialize releases.json if it doesn't exist
          if [ ! -f releases.json ]; then
            echo '{"releases":[]}' > releases.json
          fi

          # Check if this version already exists
          EXISTS=$(jq -r --arg v "$VERSION" 'any(.releases[]; .version == $v)' releases.json)

          if [ "$EXISTS" = "true" ]; then
            echo "Version $VERSION already recorded. Nothing to do."
            exit 0
          fi

          echo "New version detected! Updating releases.json..."

          # Add new release to the top and keep last 20
          jq --arg v "$VERSION" \
             --arg n "$DESCRIPTION" \
             '{releases: ([{version: $v, description: $n}] + .releases | .[0:20])}' \
             releases.json > releases_tmp.json

          mv releases_tmp.json releases.json

          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: ${{ steps.check.outputs.updated == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add releases.json
          git commit -m "Release notes: v${NEW_VERSION}"
          git push
          echo "Pushed update for v${NEW_VERSION}"